package com.jetbrains.gitalso.validation

import com.jetbrains.gitalso.log.Action
import com.jetbrains.gitalso.log.Factor
import com.jetbrains.gitalso.log.LogEvent
import com.jetbrains.gitalso.log.LogField
import com.jetbrains.gitalso.log.State
import junit.framework.TestCase.assertTrue
import junit.framework.TestCase.assertNotNull
import junit.framework.TestCase.assertNull
import org.junit.Test

class ClientLogValidatorTest {

    @Test
    fun `test validate from event`() {
        val event = LogEvent(
                System.currentTimeMillis() / 1000,
                "gitalso",
                "1.0",
                "testID",
                "1",
                Action.COMMIT,
                "1",
                mapOf(
                        LogField.FACTORS to mapOf("(123, 111)" to mapOf(
                                Factor.SCORES to arrayOf(1.0, 1.1, 1.2),
                                Factor.COMMITS to listOf(1, 2, 3),
                                Factor.COMMITS_SAME_AUTHOR to listOf(2, 3))),
                        LogField.REPOSITORY to "1",
                        LogField.PREDICTION_UNMODIFIED to listOf("1", "2", "4"),
                        LogField.PREDICTION_MODIFIED to listOf("5", "6"),
                        LogField.FILES to listOf("11", "22", "33"),
                        LogField.STATE_BEFORE to State.BEFORE_COMMIT,
                        LogField.STATE_AFTER to State.SHOW_MAIN_DIALOG,
                        LogField.TIME to 32
                )
        )
        print(event)

        assertTrue(ClientLogValidator.validate(event, event.toString()))
    }

    @Test
    fun `test json string valid`() {
        val jsonEvent = "1533044337866\t" +
                "git-also\t" +
                "1\t" +
                "f83ce224-0b90-4d92-9c6b-4015ed97e81d\t" +
                "298236595\t" +
                "COMMIT_CLICKED\t" +
                "-1\t" +
                "{\"FACTORS\":{\"(-4518845045987458894, -6635167225237500896)\":{\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487169685000],\"SCORES\":0.43},\"(-4518845045987458894, 5648486145294831073)\":{\"COMMITS\":[1491220957000,1481555978000,1487671017000],\"SCORES\":0.36},\"(-9099143422838971160, 656358546972570365)\":{\"COMMITS\":[1504612491000],\"SCORES\":0.25},\"(-4518845045987458894, -682466324862779537)\":{\"COMMITS\":[1492425222000,1481555978000],\"SCORES\":0.28},\"(-2021491979707670791, -6635167225237500896)\":{\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1481882813000,1487169685000],\"SCORES\":0.51},\"(-9099143422838971160, -682466324862779537)\":{\"COMMITS\":[1503501485000],\"SCORES\":0.44},\"(-2021491979707670791, -682466324862779537)\":{\"COMMITS\":[1492425222000,1481555978000],\"SCORES\":0.28},\"(-9099143422838971160, -6635167225237500896)\":{\"COMMITS\":[1504612491000],\"SCORES\":0.25},\"(-4518845045987458894, 656358546972570365)\":{\"COMMITS\":[1485520524000,1482155352000],\"SCORES\":0.42},\"(-2021491979707670791, 656358546972570365)\":{\"COMMITS\":[1485520524000,1481882813000,1482155352000],\"SCORES\":0.51},\"(-9099143422838971160, 5648486145294831073)\":{\"COMMITS\":[1504612491000],\"SCORES\":0.25},\"(-2021491979707670791, 5648486145294831073)\":{\"COMMITS\":[1491220957000,1481555978000,1487671017000],\"SCORES\":0.36}},\"TIME\":4,\"PREDICTION_MODIFIED\":[-6635167225237500896],\"FILES\":[\"-2021491979707670791\",\"5344384722229180857\",\"-9099143422838971160\",\"-4518845045987458894\"],\"PREDICTION_UNMODIFIED\":[656358546972570365,-682466324862779537,5648486145294831073],\"STATE_BEFORE\":\"BEFORE_COMMIT\",\"STATE_AFTER\":\"SHOW_MAIN_DIALOG\",\"REPOSITORY\":\"-2857439612858609866\"}"

        assertNotNull(ClientLogValidator.validate(jsonEvent))
    }

    @Test
    fun `test json string invalid timestamp`() {
        val jsonEvent = "1533044337866LL\t" +
                "git-also\t" +
                "1\t" +
                "f83ce224-0b90-4d92-9c6b-4015ed97e81d\t" +
                "298236595\t" +
                "COMMIT_CLICKED\t" +
                "-1\t" +
                "{\"STATE_BEFORE\":\"BEFORE_COMMIT\",\"STATE_AFTER\":\"SHOW_MAIN_DIALOG\",\"REPOSITORY\":\"-2857439612858609866\",\"FACTORS\":{\"(-2021491979707670791, 3062978230714436309)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-4518845045987458894, -6635167225237500896)\":{\"SCORES\":0.43,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487169685000]},\"(-2021491979707670791, -6635167225237500896)\":{\"SCORES\":0.51,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1481882813000,1487169685000]},\"(-4518845045987458894, 3062978230714436309)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-2021491979707670791, 8905383807363670364)\":{\"SCORES\":0.53,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1481882813000,1487671017000,1487169685000]},\"(-4518845045987458894, 656358546972570365)\":{\"SCORES\":0.42,\"COMMITS\":[1485520524000,1482155352000]},\"(-2021491979707670791, -7723308003728856841)\":{\"SCORES\":0.50,\"COMMITS\":[1485520524000,1481555978000,1481882813000,1482155352000]},\"(-2021491979707670791, 656358546972570365)\":{\"SCORES\":0.51,\"COMMITS\":[1485520524000,1481882813000,1482155352000]},\"(-4518845045987458894, 8905383807363670364)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-4518845045987458894, -7723308003728856841)\":{\"SCORES\":0.41,\"COMMITS\":[1485520524000,1481555978000,1482155352000]}},\"PREDICTION_MODIFIED\":[-6635167225237500896],\"PREDICTION_UNMODIFIED\":[656358546972570365],\"FILES\":[\"-2021491979707670791\",\"5344384722229180857\",\"-4518845045987458894\"]}"

        assertNull(ClientLogValidator.validate(jsonEvent))
    }

    @Test
    fun `test json string invalid action`() {
        val jsonEvent = "1533044337866LL\t" +
                "git-also\t" +
                "1\t" +
                "f83ce224-0b90-4d92-9c6b-4015ed97e81d\t" +
                "298236595\t" +
                "COMMIT_CLICKED_NO\t" +
                "-1\t" +
                "{\"STATE_BEFORE\":\"BEFORE_COMMIT\",\"STATE_AFTER\":\"SHOW_MAIN_DIALOG\",\"REPOSITORY\":\"-2857439612858609866\",\"FACTORS\":{\"(-2021491979707670791, 3062978230714436309)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-4518845045987458894, -6635167225237500896)\":{\"SCORES\":0.43,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487169685000]},\"(-2021491979707670791, -6635167225237500896)\":{\"SCORES\":0.51,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1481882813000,1487169685000]},\"(-4518845045987458894, 3062978230714436309)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-2021491979707670791, 8905383807363670364)\":{\"SCORES\":0.53,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1481882813000,1487671017000,1487169685000]},\"(-4518845045987458894, 656358546972570365)\":{\"SCORES\":0.42,\"COMMITS\":[1485520524000,1482155352000]},\"(-2021491979707670791, -7723308003728856841)\":{\"SCORES\":0.50,\"COMMITS\":[1485520524000,1481555978000,1481882813000,1482155352000]},\"(-2021491979707670791, 656358546972570365)\":{\"SCORES\":0.51,\"COMMITS\":[1485520524000,1481882813000,1482155352000]},\"(-4518845045987458894, 8905383807363670364)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-4518845045987458894, -7723308003728856841)\":{\"SCORES\":0.41,\"COMMITS\":[1485520524000,1481555978000,1482155352000]}},\"PREDICTION_MODIFIED\":[-6635167225237500896],\"PREDICTION_UNMODIFIED\":[656358546972570365],\"FILES\":[\"-2021491979707670791\",\"5344384722229180857\",\"-4518845045987458894\"]}"

        assertNull(ClientLogValidator.validate(jsonEvent))
    }

    @Test
    fun `test json string invalid field`() {
        val jsonEvent = "1533044337866\t" +
                "git-also\t" +
                "1\t" +
                "f83ce224-0b90-4d92-9c6b-4015ed97e81d\t" +
                "298236595\t" +
                "COMMIT_CLICKED_NO\t" +
                "-1\t" +
                "{\"STATE_BEFORE_OR_NOT\":\"BEFORE_COMMIT\",\"STATE_AFTER\":\"SHOW_MAIN_DIALOG\",\"REPOSITORY\":\"-2857439612858609866\",\"FACTORS\":{\"(-2021491979707670791, 3062978230714436309)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-4518845045987458894, -6635167225237500896)\":{\"SCORES\":0.43,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487169685000]},\"(-2021491979707670791, -6635167225237500896)\":{\"SCORES\":0.51,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1481882813000,1487169685000]},\"(-4518845045987458894, 3062978230714436309)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-2021491979707670791, 8905383807363670364)\":{\"SCORES\":0.53,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1481882813000,1487671017000,1487169685000]},\"(-4518845045987458894, 656358546972570365)\":{\"SCORES\":0.42,\"COMMITS\":[1485520524000,1482155352000]},\"(-2021491979707670791, -7723308003728856841)\":{\"SCORES\":0.50,\"COMMITS\":[1485520524000,1481555978000,1481882813000,1482155352000]},\"(-2021491979707670791, 656358546972570365)\":{\"SCORES\":0.51,\"COMMITS\":[1485520524000,1481882813000,1482155352000]},\"(-4518845045987458894, 8905383807363670364)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-4518845045987458894, -7723308003728856841)\":{\"SCORES\":0.41,\"COMMITS\":[1485520524000,1481555978000,1482155352000]}},\"PREDICTION_MODIFIED\":[-6635167225237500896],\"PREDICTION_UNMODIFIED\":[656358546972570365],\"FILES\":[\"-2021491979707670791\",\"5344384722229180857\",\"-4518845045987458894\"]}"

        assertNull(ClientLogValidator.validate(jsonEvent))
    }

    @Test
    fun `test json string invalid factors type`() {
        val jsonEvent = "1533044337866\t" +
                "git-also\t" +
                "1\t" +
                "f83ce224-0b90-4d92-9c6b-4015ed97e81d\t" +
                "298236595\t" +
                "COMMIT_CLICKED\t" +
                "-1\t" +
                "{\"STATE_BEFORE\":\"BEFORE_COMMIT\",\"STATE_AFTER\":\"SHOW_MAIN_DIALOG\",\"REPOSITORY\":\"-2857439612858609866\",\"FACTORS\":[\"(-2021491979707670791, 3062978230714436309)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-4518845045987458894, -6635167225237500896)\":{\"SCORES\":0.43,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487169685000]},\"(-2021491979707670791, -6635167225237500896)\":{\"SCORES\":0.51,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1481882813000,1487169685000]},\"(-4518845045987458894, 3062978230714436309)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-2021491979707670791, 8905383807363670364)\":{\"SCORES\":0.53,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1481882813000,1487671017000,1487169685000]},\"(-4518845045987458894, 656358546972570365)\":{\"SCORES\":0.42,\"COMMITS\":[1485520524000,1482155352000]},\"(-2021491979707670791, -7723308003728856841)\":{\"SCORES\":0.50,\"COMMITS\":[1485520524000,1481555978000,1481882813000,1482155352000]},\"(-2021491979707670791, 656358546972570365)\":{\"SCORES\":0.51,\"COMMITS\":[1485520524000,1481882813000,1482155352000]},\"(-4518845045987458894, 8905383807363670364)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]],\"(-4518845045987458894, -7723308003728856841)\":{\"SCORES\":0.41,\"COMMITS\":[1485520524000,1481555978000,1482155352000]}},\"PREDICTION_MODIFIED\":[-6635167225237500896],\"PREDICTION_UNMODIFIED\":[656358546972570365],\"FILES\":[\"-2021491979707670791\",\"5344384722229180857\",\"-4518845045987458894\"]}"

        assertNull(ClientLogValidator.validate(jsonEvent))
    }

    @Test
    fun `test json string invalid factors field`() {
        val jsonEvent = "1533044337866\t" +
                "git-also\t" +
                "1\t" +
                "f83ce224-0b90-4d92-9c6b-4015ed97e81d\t" +
                "298236595\t" +
                "COMMIT_CLICKED\t" +
                "-1\t" +
                "{\"STATE_BEFORE\":\"BEFORE_COMMIT\",\"STATE_AFTER\":\"SHOW_MAIN_DIALOG\",\"REPOSITORY\":\"-2857439612858609866\",\"FACTORS\":{\"(-2021491979707670791, 3062978230714436309)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-4518845045987458894, -6635167225237500896)\":{\"SCORES\":0.43,\"COMMIT\":[1491220957000,1492425222000,1485520524000,1481555978000,1487169685000]},\"(-2021491979707670791, -6635167225237500896)\":{\"SCORES\":0.51,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1481882813000,1487169685000]},\"(-4518845045987458894, 3062978230714436309)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-2021491979707670791, 8905383807363670364)\":{\"SCORES\":0.53,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1481882813000,1487671017000,1487169685000]},\"(-4518845045987458894, 656358546972570365)\":{\"SCORES\":0.42,\"COMMITS\":[1485520524000,1482155352000]},\"(-2021491979707670791, -7723308003728856841)\":{\"SCORES\":0.50,\"COMMITS\":[1485520524000,1481555978000,1481882813000,1482155352000]},\"(-2021491979707670791, 656358546972570365)\":{\"SCORES\":0.51,\"COMMITS\":[1485520524000,1481882813000,1482155352000]},\"(-4518845045987458894, 8905383807363670364)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-4518845045987458894, -7723308003728856841)\":{\"SCORES\":0.41,\"COMMITS\":[1485520524000,1481555978000,1482155352000]}},\"PREDICTION_MODIFIED\":[-6635167225237500896],\"PREDICTION_UNMODIFIED\":[656358546972570365],\"FILES\":[\"-2021491979707670791\",\"5344384722229180857\",\"-4518845045987458894\"]}"

        assertNull(ClientLogValidator.validate(jsonEvent))
    }

    @Test
    fun `test json string invalid factors field type`() {
        val jsonEvent = "1533044337866\t" +
                "git-also\t" +
                "1\t" +
                "f83ce224-0b90-4d92-9c6b-4015ed97e81d\t" +
                "298236595\t" +
                "COMMIT_CLICKED\t" +
                "-1\t" +
                "{\"STATE_BEFORE\":\"BEFORE_COMMIT\",\"STATE_AFTER\":\"SHOW_MAIN_DIALOG\",\"REPOSITORY\":\"-2857439612858609866\",\"FACTORS\":{\"(-2021491979707670791, 3062978230714436309)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-4518845045987458894, -6635167225237500896)\":{\"SCORES\":\"0.43\",\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487169685000]},\"(-2021491979707670791, -6635167225237500896)\":{\"SCORES\":0.51,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1481882813000,1487169685000]},\"(-4518845045987458894, 3062978230714436309)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-2021491979707670791, 8905383807363670364)\":{\"SCORES\":0.53,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1481882813000,1487671017000,1487169685000]},\"(-4518845045987458894, 656358546972570365)\":{\"SCORES\":0.42,\"COMMITS\":[1485520524000,1482155352000]},\"(-2021491979707670791, -7723308003728856841)\":{\"SCORES\":0.50,\"COMMITS\":[1485520524000,1481555978000,1481882813000,1482155352000]},\"(-2021491979707670791, 656358546972570365)\":{\"SCORES\":0.51,\"COMMITS\":[1485520524000,1481882813000,1482155352000]},\"(-4518845045987458894, 8905383807363670364)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-4518845045987458894, -7723308003728856841)\":{\"SCORES\":0.41,\"COMMITS\":[1485520524000,1481555978000,1482155352000]}},\"PREDICTION_MODIFIED\":[-6635167225237500896],\"PREDICTION_UNMODIFIED\":[656358546972570365],\"FILES\":[\"-2021491979707670791\",\"5344384722229180857\",\"-4518845045987458894\"]}"

        assertNull(ClientLogValidator.validate(jsonEvent))
    }

    @Test
    fun `test json string invalid pair`() {
        val jsonEvent = "1533044337866\t" +
                "git-also\t" +
                "1\t" +
                "f83ce224-0b90-4d92-9c6b-4015ed97e81d\t" +
                "298236595\t" +
                "COMMIT_CLICKED\t" +
                "-1\t" +
                "{\"STATE_BEFORE\":\"BEFORE_COMMIT\",\"STATE_AFTER\":\"SHOW_MAIN_DIALOG\",\"REPOSITORY\":\"-2857439612858609866\",\"FACTORS\":{\"-2021491979707670791_3062978230714436309\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-4518845045987458894, -6635167225237500896)\":{\"SCORES\":0.43,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487169685000]},\"(-2021491979707670791, -6635167225237500896)\":{\"SCORES\":0.51,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1481882813000,1487169685000]},\"(-4518845045987458894, 3062978230714436309)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-2021491979707670791, 8905383807363670364)\":{\"SCORES\":0.53,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1481882813000,1487671017000,1487169685000]},\"(-4518845045987458894, 656358546972570365)\":{\"SCORES\":0.42,\"COMMITS\":[1485520524000,1482155352000]},\"(-2021491979707670791, -7723308003728856841)\":{\"SCORES\":0.50,\"COMMITS\":[1485520524000,1481555978000,1481882813000,1482155352000]},\"(-2021491979707670791, 656358546972570365)\":{\"SCORES\":0.51,\"COMMITS\":[1485520524000,1481882813000,1482155352000]},\"(-4518845045987458894, 8905383807363670364)\":{\"SCORES\":0.45,\"COMMITS\":[1491220957000,1492425222000,1485520524000,1481555978000,1487671017000,1487169685000]},\"(-4518845045987458894, -7723308003728856841)\":{\"SCORES\":0.41,\"COMMITS\":[1485520524000,1481555978000,1482155352000]}},\"PREDICTION_MODIFIED\":[-6635167225237500896],\"PREDICTION_UNMODIFIED\":[656358546972570365],\"FILES\":[\"-2021491979707670791\",\"5344384722229180857\",\"-4518845045987458894\"]}"

        assertNull(ClientLogValidator.validate(jsonEvent))
    }

}